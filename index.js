//CALLEDHXX Nov/2024

let Squares = [
    {

        Name:"歡迎光臨",

        Details:"按下 Enter 繼續。",

        Image:"",

        Page:"/f/welcome.json",

        Color: "8aa93c",

        states:[
            ["🌴","歡樂島"]
        ],

        id : "wel"

    },
    {

        Name:"個人檔案",

        Details:"Hxx的個人檔案。",

        Image:"/f/img/0324.gif",

        Page:"/f/main.json",

        Color: "5d3ca9",

        states:[
            ["😗","好喔"]
        ],

        id : "hxx"

    },

    {
        Name:"7SunFish",
        Details:"Hxx的好朋友",
        Image:"/f/img/a9a72e835d8a6266b636180a30014def.png",
        Page:"/f/7sf.json",
        Color: "c1842b",

        states:[
            ["🐟","魚國國王"],
            ["🦄","「獨」家"]
        ],

        id : "7sf"

    },
    {
        Name:"我所對不起的你",
        Details:"獻給你，朋友。",
        Image:"",
        Page:"/f/sry.json",
        Color: "4e46b8",

        states:[
            ["🦄","「獨」家"],
            ["🔮","另個世界"],

        ],

        id : "sry"

    },
    {
        Name:"Uzi特寫",
        Details:"Uzi的特寫照外流。",
        Image:"/f/img/IMG_9089.jpg",
        Page:"/f/uzi.json",
        Color: "7946b8",

        states:[
            ["🔮","另個世界"],
            ["🤖","魔腦"],

        ],

        id : "uzi"

    },
    {
        Name:"散文集：短",
        Details:"Hxx的個人散文專輯。",
        Image:"",
        Page:"/f/fshort.json",
        Color: "4699d9",

        states:[
            ["😶‍🌫️","羞羞"],
            ["😖","腦羞"],

        ],

        id : "fshort"
    },
    {
        Name:"散文集：長",
        Details:"Hxx的個人散文專輯。",
        Image:"",
        Page:"/f/flong.json",
        Color: "d94646",

        id : "flong"
    },
    {
        Name:"Minecraft",
        Details:"Hxx的遊玩Minecraft的紀錄。",
        Image:"/f/img/minecraft.png",
        Page:"/f/minecraft.json",
        Color: "85471d",

        id : "minecraft",

        states:[
            [
                "🍀","好信運"
            ],
            [
                "🐳","「鯨」訝不已"
            ],
            [
                "🪐","我不知道這是甚麼"
            ]
        ]

    },
    {
        Name:"芙莉蓮",
        Details:"芙莉蓮戰品特級。",
        Image:"/f/img/IMG_9684 - 複製.jpg",
        Page:"/f/fll.json",
        Color: "56c4cb",

        states:[
            ["🥰","ㄒㄧˇ愛"],
        ],

        id : "fll"
    },
    {
        Name:"Hxx圖片支援",
        Details:"部分媒體已標出原出處。",
        Image:"/f/img/IMG_E8875.JPG",
        Page:"/f/memes.json",
        Color: "a849a8",

        id : "memes",

        states:[
            [
                "⭐","精選"
            ],
            [
                "🫠","好酷"
            ],
            [
                "🫨","暈暈的"
            ],
        ]
    },
    {
        Name:"好吃馬鈴薯",
        Details:"發霉的馬鈴薯。",
        Image:"/f/img/472562154_578862491593902_4960175299312110464_n (1) - 複製.jpg",
        Page:"/f/potato.json",
        Color: "b06340",

        states:[
            ["🦄","「獨」家"],
            ["🥶️","羞澀"],

        ],

        id : "potato"
    },
    {
        Name:"Roblox",
        Details:"讓Hxx打開另扇大門的媒介。",
        Image:"/f/img/螢幕擷取畫面 2024-12-22 091330.png",
        Page:"/f/roblox.json",
        Color: "4d2f28",

        states:[
            ["🤚","\"Touch grass\""],
            ["🫎","轆轆轆轆轆"],
            ["🪨","硬核:skull:"]

        ],

        id : "roblox"
    },
    {
        Name:"MiSide",
        Details:"非常推薦的恐怖遊戲！",
        Image:"/f/img/螢幕擷取畫面 2025-01-24 164159.png",
        Page:"/f/MiSide.json",
        Color: "642881",

        states:[
            ["🤩","超愛"],
            ["😍","愛死了"],

        ],

        id : "miside"
    },
    {
        Name:"Mione語言",
        Details:"Hxx在開發的程式語言！",
        Image:"",
        Page:"/f/mione.json",
        Color: "812862",

        states:[
            ["🖥️","嗶嗶啵啵嗶嗶！"],
            ["⭐","非常酷"],

        ],

        id : "mione"
    },
    {
        Name:"非常破的魚",
        Details:"又Pro又破的魚種。",
        Image:"/f/img/32f8f2203ecb889671ddd843e2d737b9.png",
        Page:"/f/mione.json",
        Color: "9fa6a5",

        states:[
            ["🫧","啵啵啵，缺氧"],
            ["🦄","「獨」家"],

        ],

        id : "mione"
    },
    {
        Name:"水泥人Dummy",
        Details:"曾經入海成消波塊。",
        Image:"/f/img/螢幕擷取畫面 2025-01-27 203611.png",
        Page:"/f/mione.json",
        Color: "5879de",

        states:[
            ["🧱","快曬成磚了"],
            ["🪨","他的祖先"],

        ],

        id : "mione"
    },
    {
        Name:"IronMan肛鐵人",
        Details:"他名子很像IronMan。",
        Image:"/f/img/148810bbcbcc4db37d2ec8188a8a6399.png",
        Page:"/f/mione.json",
        Color: "b26715",

        states:[
            ["🦊","毛毛der"],
            ["😮","很酷"],

        ],

        id : "mione"
    },
    {
        Name:"DJ JD",
        Details:"JD同時也是約會軟體 :o",
        Image:"/f/img/52929faad24d847a8c75de0d10dd082e.png",
        Page:"/f/mione.json",
        Color: "478ab7",

        states:[
            ["🪲","第二代Bug大師"],
            ["💀",":skull:"],

        ],

        id : "mione"
    },
    {
        Name:"醫生害怕蘋果",
        Details:"DoctorFish，可能會是醫生:OOOO",
        Image:"/f/img/3cefb2f1f8b976328364daafe647af0d.png",
        Page:"/f/mione.json",
        Color: "b78a47",

        states:[
            ["🍎","他的天敵"],
            ["🦄","「獨」家"],

        ],

        id : "mione"
    },
    {
        Name:"Wenson",
        Details:"明顯是為正仁君子。",
        Image:"/f/img/b5e403d11dfed3329ed8a275f9313f7f.png",
        Page:"/f/mione.json",
        Color: "3d739f",

        states:[
            ["🪭","優雅"],
            ["😮","好酷"],

        ],

        id : "mione"
    }
]

let BubbleXSize = 900;
let BubbleYSize = 720;

let Bubbles = [

];
let BubbleInfos = [

];

let MidY = 0;
let MidX = 0;

let mapSize;

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async  function tweenMsgMove(obj,toY,sec,lag){
    let perSecY = (toY-obj.style.bottom.substring(0,obj.style.bottom.length-2))/(sec*10);

    let Y = Number(obj.style.bottom.substring(0,obj.style.bottom.length-2));

    for (let i = 0;i<(10*sec);i++){

        obj.style.bottom = Y+perSecY+"px";

        await sleep(lag);


        Y = Number(obj.style.bottom.substring(0,obj.style.bottom.length-2));
    }

    obj.style.bottom = toY+"px";
}

let msgStyle3d="";

async function MessageIt(Title,Reason){

    if (Title&&Reason){
        let AMessageCase = document.createElement("button");
        AMessageCase.classList.add("AMessageCase");
        await tweenMsgMove(AMessageCase,-300,1,1);
        await sleep(100);



        let MessageTouchBox = document.createElement("div");
        MessageTouchBox.classList.add("MessageTouchBox");

        let MessageImage = document.createElement("img");
        MessageImage.classList.add("MessageImage");
        MessageImage.src = "path248.png";

        let MessageContentCase = document.createElement("div");
        MessageContentCase.classList.add("MessageContentCase");

        let MessageContent1 = document.createElement("h1");
        MessageContent1.classList.add("MessageContent1");
        MessageContent1.textContent = Title;

        let MessageContent2 = document.createElement("h2");
        MessageContent2.classList.add("MessageContent2");
        MessageContent2.textContent = Reason;

        AMessageCase.style.transform = msgStyle3d;

        document.getElementById("MessagesCase").appendChild(AMessageCase);
        AMessageCase.appendChild(MessageTouchBox);
        AMessageCase.appendChild(MessageImage);
        AMessageCase.appendChild(MessageContentCase);
        MessageContentCase.appendChild(MessageContent1);
        MessageContentCase.appendChild(MessageContent2);

        AMessageCase.addEventListener("click", async function(){
            tweenMsgMove(AMessageCase,-500,3,1);
            await sleep(100);
            AMessageCase.remove();
            MessageIt();
        })



        await tweenMsgMove(AMessageCase,0,1,1);

    }




    let papa = document.getElementById("MessagesCase").children;
    //Number(papa[i].id.substring(0,papa[i].id.length-4))
    for (let i = 0;i<papa.length;i++){
        let Index = papa.length - i - 1;
        tweenMsgMove(papa[Index],20*(papa.length - i - 1),1,1);
        await sleep(10);

        papa[Index].style.zIndex = 100+i;
    }



}

let tweenMoveIndex = 0;
let tweenMoveObj;
async  function tweenMove(obj,toX,toY,sec,lag,moveOut){
    tweenMoveObj = obj;
    tweenMoveIndex++;
    let perSecX = (toX-obj.style.left.substring(0,obj.style.left.length-2))/(sec*10);
    let perSecY = (toY-obj.style.top.substring(0,obj.style.top.length-2))/(sec*10);

    let X =  Number(obj.style.left.substring(0,obj.style.left.length-2));
    let Y = Number(obj.style.top.substring(0,obj.style.top.length-2));

    let LastTMI = tweenMoveIndex;

    for (let i = 0;i<(10*sec);i++){
        if (moveOut) if (LastTMI!== tweenMoveIndex) if(obj === tweenMoveObj) break;

        obj.style.left = X+perSecX+"px";
        obj.style.top = Y+perSecY+"px";

        await sleep(lag);


        X =  Number(obj.style.left.substring(0,obj.style.left.length-2));
        Y = Number(obj.style.top.substring(0,obj.style.top.length-2));
    }

    obj.style.left = toX+"px";
    obj.style.top = toY+"px";

}

let tweenSizeIndex = 0;
let tweenSizeObj;

async  function tweenSize(obj,toX,toY,sec,lag,sizeOut){
    tweenSizeObj = obj;
    tweenSizeIndex++;
    let perSecX = (toX-obj.style.width.substring(0,obj.style.width.length-2))/(sec*10);
    let perSecY = (toY-obj.style.height.substring(0,obj.style.height.length-2))/(sec*10);

    let X =  Number(obj.style.width.substring(0,obj.style.width.length-2));
    let Y = Number(obj.style.height.substring(0,obj.style.height.length-2));

    let LastTSI = tweenSizeIndex;


    for (let i = 0;i<(10*sec);i++){
        if (sizeOut) if (LastTSI!== tweenSizeIndex)  if(obj === tweenSizeIndex)  break;


        obj.style.width = X+perSecX+"px";
        obj.style.height = Y+perSecY+"px";

        await sleep(lag);


        X =  Number(obj.style.width.substring(0,obj.style.width.length-2));
        Y = Number(obj.style.height.substring(0,obj.style.height.length-2));
    }



    obj.style.width = toX+"px";
    obj.style.height = toY+"px";


}

async  function tweenPos(obj,toX,toY,sec,lag){
    let perSecX = (toX-obj.style.backgroundPositionX.substring(0,obj.style.backgroundPositionX.length-2))/(sec*10);
    let perSecY = (toY-obj.style.backgroundPositionY.substring(0,obj.style.backgroundPositionY.length-2))/(sec*10);

    let X =  Number(obj.style.backgroundPositionX.substring(0,obj.style.backgroundPositionX.length-2));
    let Y = Number(obj.style.backgroundPositionY.substring(0,obj.style.backgroundPositionY.length-2));



    for (let i = 0;i<(10*sec);i++){

        obj.style.backgroundPositionX = X+perSecX+"px";
        obj.style.backgroundPositionY = Y+perSecY+"px";

        await sleep(lag);


        X =  Number(obj.style.backgroundPositionX.substring(0,obj.style.backgroundPositionX.length-2));
        Y = Number(obj.style.backgroundPositionY.substring(0,obj.style.backgroundPositionY.length-2));
    }



    obj.style.backgroundPositionX = toX+"px";
    obj.style.backgroundPositionY = toY+"px";


}

let Oy = 0;

let LastMidX = 0;
let LastMidY = 0;

let LimSquares = {
    "Moved100" : {

        Name:"百步之途",

        Details:"致上最高的敬禮",

        Image:"",

        Page:"/f/m100.json",

        Color: "a93c74",

        id : "m100",

        states:[
            [
                "🐫","駱駝都沒比你有耐力"
            ]
        ]


    },
    "msl" : {

        Name:"奇怪的林亮教!",

        Details:"神來臨",

        Image:"/f/img/IMG_9453 - 複製.JPG",

        Page:"/f/msl.json",

        Color: "3b7ec2",

        id : "msl",

        states:[
            [
                "😮","教的力量"
            ]
        ]

    }
}

let creatBubble = function(BubbleSqr){ //Create???
    let BubblesTotal= 0;
    for (let _y =0;_y<Bubbles.length; _y++){
        for (let _x=0;_x<Bubbles[_y].length; _x++) BubblesTotal++ ;
    }

    let fit = Math.sqrt(BubblesTotal+1) - Math.floor(Math.sqrt(BubblesTotal+1)) === 0;

    let NewMapSize = fit ? Math.sqrt(BubblesTotal+1) : Math.floor(Math.sqrt(BubblesTotal+1))+1;

    let newBubbles = [];
    let newBubbleInfos = [];

    for (let i = 0; i <NewMapSize; i++) {
        newBubbles[i] = [];
    }

    for (let i = 0; i <BubbleInfos.length; i++) newBubbleInfos[i] = BubbleInfos[i];


    for (let Y = 0; Y < NewMapSize; Y++){
        for (let X = 0; X < NewMapSize; X++){
            if (BubblesTotal<=Y*2+X) break;
            let v = 0;
            for (let yy = 0; yy < mapSize; yy++) {
                for (let xx = 0; xx < mapSize; xx++) {
                    if (Y*NewMapSize+X === yy*mapSize+xx){
                        v = Bubbles[yy][xx];
                        break;
                    }
                }
            }

            if(v){
                newBubbles[Y][X] = v;
            }else{
                if (Y===X&&X===0) newBubbles[Y][X] = v;
            }
        }
    }

    console.log(Bubbles,newBubbles);

    newBubbleInfos[newBubbleInfos.length] = BubbleSqr;

    Bubbles = newBubbles;
    BubbleInfos = newBubbleInfos;
    mapSize = NewMapSize;





    let button = document.createElement("button");
    let h2 = document.createElement("h2");
    let h6 = document.createElement("h6");
    let img = document.createElement("img");


    h2.textContent =BubbleSqr.Name;
    button.style.backgroundColor = "#" + BubbleSqr.Color;
    h2.style.color = "#" + hex(BubbleSqr.Color,"333333", +1);
    h6.style.color = "#" + hex(BubbleSqr.Color,"111111", +1);
    button.style.borderColor = "#" + hex(BubbleSqr.Color,"111111", -1);

    button.style.boxShadow = " 0 0 30px 3px #"+hex(BubbleSqr.Color,"111111", +1);



    let states = document.createElement("div");

    states.classList.add("states");

    if(BubbleSqr.states){
        for (let s = 0;s<BubbleSqr.states.length;s++){
            let aState = document.createElement("h6");
            aState.innerText = BubbleSqr.states[s][0];
            aState.classList.add("aState");
            states.appendChild(aState);
        }
    }

    button.style.left = window.innerWidth/2+"px";
    button.style.top = window.innerHeight/2+"px";

    button.style.width =  "50px";
    button.style.height = "50px";

    button.id = "bubble_"+BubbleSqr.id;

    button.classList.add("Square");

    button.classList.add(BubblesTotal);

    img.classList.add("Icon");

    button.appendChild(img);

    button.appendChild(h2);
    button.appendChild(h6);

    button.appendChild(states);

    document.getElementById("Bubbles").appendChild(button);

    let db = 0;
    for (let Y = 0; Y < mapSize; Y++) {
        for (let X = 0; X < mapSize; X++) {
            if (Y === 0 && X === 0){}else{
                if (Bubbles[Y][X]){}else {
                    Bubbles[Y][X] = BubblesTotal;
                    db = 1;
                    break;
                }
            }
        }
        if (db){
            break;
        }
    }


}

let a = async function(){
    let X = 0;
    let Y = 0;

    let XfirstPix = Math.floor(window.innerWidth/2)-55//Math.floor((mapSize/2)*55);
    let YfirstPix = Math.floor(window.innerHeight/2)-55//Math.floor((mapSize/2)*55);

    let xGen = 60;
    let yGen = 60;

    let CX = Math.floor(MidX/mapSize*30);
    let CY = Math.floor(MidY/mapSize*30);


    //
    let moved = document.cookie.replace(
        /(?:(?:^|.*;\s*)moved\s*\=\s*([^;]*).*$)|^.*$/,
        "$1",
    );

    if (Math.abs(MidX - LastMidX)){
        document.cookie = "moved="+(Number(moved)+1)+";";
    }
    if (Math.abs(MidY - LastMidY)){
        document.cookie = "moved="+(Number(moved)+1)+";";
    }



    if (Number(moved)>=100 && !document.getElementById("bubble_m100")){
        creatBubble(LimSquares["Moved100"]);
        MessageIt("好像有東西？","有神秘泡泡出來了，趕緊找找！");
    }


    //

    //

     tweenPos(document.getElementById("BackGround"),-MidX*20,-MidY*20,3,.1);



    //


    for (let y = 0;y<Bubbles.length;y++) {
        X = 0;
        for (let x = 0; x < Bubbles[y].length; x++) {

            if (MidY - y === 0){
                yGen = 120;
            }else{
                yGen = 60;
            }




            if (MidX - x === 0){
                //  document.getElementsByClassName(Bubbles[y][x])[0].style.backgroundColor = "red";

            }else{

                if (MidY - y === 0){
                    // document.getElementsByClassName(Bubbles[y][x])[0].style.backgroundColor = "blue";

                }else{
                    // document.getElementsByClassName(Bubbles[y][x])[0].style.backgroundColor = "red";
                }

            }


            let disY =  (MidX - x === 0 && MidY - y === 0) ? 60 : 0;
            let EasY = 0;

            let SqrData = BubbleInfos[y*mapSize + x];


            if (SqrData){}else{break;}


            if (MidY - y <= -1){
                if (x === MidX || x === MidX+1){
                    //document.getElementsByClassName(Bubbles[y][x])[0].style.backgroundColor = "green";
                }else{
                    EasY =- 60;
                }
            }



            //+ (Number(document.getElementsByClassName(Bubbles[y][x])[0].style.width.substring(0,document.getElementsByClassName(Bubbles[y][x])[0].style.width.length-2)))/5
            //+  (Number(document.getElementsByClassName(Bubbles[y][x])[0].style.height.substring(0,document.getElementsByClassName(Bubbles[y][x])[0].style.height.length-2)))/5


             tweenMove(document.getElementsByClassName(Bubbles[y][x])[0]
                , -MidX*55+XfirstPix+X - CX
                ,-MidY*55+YfirstPix+Y + disY + EasY - CY
                ,
                 .8,
                10,true)




            if (MidX - x === 0 && MidY - y === 0){
                 tweenSize(document.getElementsByClassName(Bubbles[y][x])[0],110,110,.5,10,true);
                xGen = 120;

                document.getElementsByClassName(Bubbles[y][x])[0].children[1].textContent = SqrData.Name;
                document.getElementsByClassName(Bubbles[y][x])[0].children[2].textContent = SqrData.Details;
                document.getElementsByClassName(Bubbles[y][x])[0].children[1].style.fontSize = "20px";
                document.getElementsByClassName(Bubbles[y][x])[0].children[2].style.fontSize = "13px";


                for(let c = 0;c<document.getElementsByClassName(Bubbles[y][x])[0].children[3].children.length;c++){
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.fontSize = "30px";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.marginLeft = "5px";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.marginRight = "5px";
                }
                document.getElementsByClassName(Bubbles[y][x])[0].children[3].style.top = "-20%";




                if ( SqrData.Image === ""){

                }   else{
                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].src = "";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].style.width = "0";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[1].textContent = SqrData.Name;
                    document.getElementsByClassName(Bubbles[y][x])[0].children[1].style.fontSize = "20px";

                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].style.position = "absolute";


                }


            }else{
                 tweenSize(document.getElementsByClassName(Bubbles[y][x])[0],50,50,.3,10,true);
                xGen = 60;

                for(let c = 0;c<document.getElementsByClassName(Bubbles[y][x])[0].children[3].children.length;c++){
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.fontSize = "20px";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.marginLeft = "-1px";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[3].children[c].style.marginRight = "-1px";
                }
                document.getElementsByClassName(Bubbles[y][x])[0].children[3].style.top = "-40%";



                document.getElementsByClassName(Bubbles[y][x])[0].children[1].textContent = SqrData.Name.substring(0,1);
                document.getElementsByClassName(Bubbles[y][x])[0].children[1].style.fontSize = "26px";

                document.getElementsByClassName(Bubbles[y][x])[0].children[2].textContent = SqrData.Details;
                document.getElementsByClassName(Bubbles[y][x])[0].children[2].style.fontSize = "0";

                if ( SqrData.Image === ""){
                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].style.position = "absolute";
                }   else{
                    document.getElementsByClassName(Bubbles[y][x])[0].children[1].style.fontSize = "0";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[2].style.fontSize = "0";

                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].style.width = "90%";
                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].src = SqrData.Image;

                    document.getElementsByClassName(Bubbles[y][x])[0].children[0].style.position = "relative";
                }


            }


            // document.getElementsByClassName(Bubbles[y][x])[0].style.left = -MidX*55+XfirstPix+X+"px";
            // document.getElementsByClassName(Bubbles[y][x])[0].style.top = -MidY*55+YfirstPix+Y+"px";

            X = X+xGen;
        }

        Y = Y+yGen;
    }

    LastMidX = MidX;
    LastMidY = MidY;
};

function hex(a,b,c){
    let str = [
        '0',
        '1',
        '2',
        '3',
        '4',
        '5',
        '6',
        '7',
        '8',
        '9',
        'a',
        'b',
        'c',
        'd',
        'e',
        'f',
    ];


    let abc = function(v){
        for (let i = 0;i<str.length;i++){
            if (str[i] === v){
                return i;
            }
        }
    }

    let Red = 0;
    let Green = 0;
    let Blue = 0;



    Red = Red + abc(a.substring(0,1))*16;
    Red = Red + abc(a.substring(1,2));

    Green = Green +  abc(a.substring(2,3))*16;
    Green = Green + abc(a.substring(3,4));

    Blue = Blue + abc(a.substring(4,5))*16;
    Blue = Blue + abc(a.substring(5,6));


    Red = Red +  c * abc(b.substring(0,1))*16;
    Red = Red +  c * abc(b.substring(1,2));

    Green = Green +   c*abc(b.substring(2,3))*16;
    Green = Green +  c*abc(b.substring(3,4));

    Blue = Blue +  c*abc(b.substring(4,5))*16;
    Blue = Blue +  c*abc(b.substring(5,6));


    let re = "";


    re = re + (str[ Math.floor(Red/16)] ? str[Math.floor(Red/16)] : "f")  +  (str[Red%16] ? str[Red%16] : "f");
    re = re + (str[ Math.floor(Green/16)] ? str[Math.floor(Green/16)] : "f")  +  (str[Green%16] ? str[Green%16] : "f");
    re = re + (str[ Math.floor(Blue/16)] ? str[Math.floor(Blue/16)] : "f")  +  (str[Blue%16] ? str[Blue%16] : "f");





    return re;
}

document.addEventListener("DOMContentLoaded",   async function(){


    MessageIt("我們的餅乾 Cookie","本網站直接紀錄使用者的動作至Cookie裡，若有需求者，可直接清除本網站的Cookie。");


    let fit = Math.sqrt(Squares.length) - Math.floor(Math.sqrt(Squares.length)) === 0;

    mapSize = fit ? Math.sqrt(Squares.length) : Math.floor(Math.sqrt(Squares.length))+1;


    for (let i = 0; i <mapSize; i++) {
        Bubbles[i] = [];
    }

    for (let i = 0; i < Squares.length; i++) {
        Bubbles[Math.floor(i/mapSize)][i-Math.floor(i/mapSize)*mapSize] = i;
        BubbleInfos[i] = Squares[i];
    }


    if (document.cookie === ""){
        document.cookie = "moved=0;";
    }

    for (let i = 0; i < Squares.length; i++){


        let button = document.createElement("button");
        let h2 = document.createElement("h2");
        let h6 = document.createElement("h6");
        let img = document.createElement("img");

        let states = document.createElement("div");

        h2.textContent = Squares[i].Name;
        button.style.backgroundColor = "#" + Squares[i].Color;
        h2.style.color = "#" + hex(Squares[i].Color,"333333", +1);
        h6.style.color = "#" + hex(Squares[i].Color,"111111", +1);
        button.style.borderColor = "#" + hex(Squares[i].Color,"111111", -1);

        button.style.boxShadow = "0 0  30px 3px  #"+hex(Squares[i].Color,"111111", +1);


        button.style.left = window.innerWidth/2+"px";
        button.style.top = window.innerHeight/2+"px";

        button.style.width =  "50px";
        button.style.height = "50px";

        button.id = "bubble_"+Squares[i].id;

        if(Squares[i].states){
            for (let s = 0;s<Squares[i].states.length;s++){
                let aState = document.createElement("h6");
                aState.innerText = Squares[i].states[s][0];
                aState.classList.add("aState");
                states.appendChild(aState);
            }
        }

        button.classList.add("Square");
        button.classList.add(i);

        img.classList.add("Icon");
        
        button.appendChild(img);

        button.appendChild(h2);
        button.appendChild(h6);

        states.classList.add("states");

        button.appendChild(states);


        document.getElementById("Bubbles").appendChild(button);
    }


    //document.getElementsByClassName(Bubbles[y][x])[0].style.left = -MidX*55+XfirstPix+X+"px";
    //document.getElementsByClassName(Bubbles[y][x])[0].style.top = -MidY*55+YfirstPix+Y+"px";


    await a();

    console.log(BubbleInfos);

    let parts = new URLSearchParams(  window.location.search);
    let Found = 0;
    for (let i = 0;i<BubbleInfos.length;i++){
        if (parts.get('bubble')){} else {Found= 2;break;}
        if (BubbleInfos[i].id.toLowerCase() === parts.get('bubble').toLowerCase()){
            MidY = Math.floor(i/mapSize);
            MidX = i%mapSize;
            Found = 1;
        }
    }



    if(Found){
        if (Found === 1){
            await sleep(300);
            MessageIt("泡泡！","找到你要的泡泡了，請享受它吧！");

            await a();
        }

    }
    else{
        MessageIt("找不到泡泡。","鴨鴨說他很不好意思，他找不到你想要的泡泡。🤔");
    }

    document.getElementById("Page").addEventListener("scroll", function() {
        const scrollTop = document.getElementById("Page").scrollTop;
        const deg = scrollTop/(document.getElementById("Page").scrollHeight-document.getElementById("Page").clientHeight);

        document.getElementById("Card").style.transform = "rotateX("+String((deg-0.5)*50)+"deg) translate(-50%, -50%)";

    });
});



let inUi = false;


let lastTimeEnt = new Date().getTime();

async function ent(a){
    if(a){
        if(inUi){
            tweenMove(document.getElementById("Card"),window.innerWidth/2,window.innerHeight/2,1,1);

        }
        return;
    }


    if (((new Date().getTime()) - lastTimeEnt)>=200){
        lastTimeEnt= new Date().getTime();
    }else{
        return;
    }



    let SqrData = BubbleInfos[MidY*mapSize+MidX];




    if (inUi){
        inUi = false;



        tweenSize(document.getElementById("Card"),100,0,1,6);
        tweenMove(document.getElementById("Card"),window.innerWidth/2,window.innerHeight,0.000001,1);

        document.getElementById("TopBar").style.borderWidth =  "0";
        document.getElementById("TopBar").style.borderColor = "rgba(0,0,0,0)";


        await sleep(100);

        document.getElementById("TopBarImg").src = "";
        document.getElementById("TopBarText").textContent = "";

        tweenMove(document.getElementById("Card"),0,-300,0.000001,1);

        let n = document.getElementsByClassName("Case").length;
        for (let i =0 ;i<n;i++){
            document.getElementById("Page").removeChild(document.getElementsByClassName("Case")[document.getElementsByClassName("Case").length-1]);
        }


        async function _blur(){
            for (let i = 10;i>0;i--){
                document.getElementById("BackGround").style.filter = "blur("+String(i-1)+"px)";
                await sleep(50);
            }

        }
        _blur();



    }else{
        inUi = true;

         tweenSize(document.getElementsByClassName(Bubbles[MidY][MidX])[0],96,96,1,10,true);
        await sleep(70);
         tweenSize(document.getElementsByClassName(Bubbles[MidY][MidX])[0],110,110,1,10,true);

        if (SqrData.id === "7sf") MessageIt("太陽魚！","太陽魚是Hxx最好的好友。Hxx對我的愛都轉移到了他身上啊！！！😭");
        if (SqrData.id === "m100") MessageIt("100次移動！","恭喜完成100次移動！😗");
        if (SqrData.id === "minecraft") MessageIt("Minecraft！","話說你玩過Minecraft嗎？ 如果有，你可以想盡辦法聯繫到Hxx並與他共玩！");

        document.getElementById("Card").style.backgroundColor = "#" + SqrData.Color+"AA";
        document.getElementById("Card").style.borderColor = "#" + hex(SqrData.Color,"111111",-1);
        document.getElementById("Card").style.color = "#" + hex(SqrData.Color,"311141", 1);



        document.getElementById("TopBar").style.backgroundColor =  "#" + hex(SqrData.Color,"112211",-1)+"7A";
        document.getElementById("TopBar").style.borderWidth =  "3px";
        document.getElementById("TopBar").style.borderColor =  "#" + hex(SqrData.Color,"111111",-1);


        document.getElementById("Card").style.boxShadow = "0 0 300px 30px #"+hex(SqrData.Color,"111111", +1);
        document.getElementById("TopBar").style.boxShadow =  "0 0 30px #"+hex(SqrData.Color,"333333",+1);

        document.getElementById("TopBarText").style.color =  "#" + hex(SqrData.Color,"222222", 1);



        document.getElementById("TopBarImg").src = SqrData.Image;
        document.getElementById("TopBarText").textContent = SqrData.Name;





        tweenMove(document.getElementById("Card"),window.innerWidth/2,window.innerHeight,0.000001,1);

        await sleep(50);


        document.getElementById("Card").style.height = "auto";
        document.getElementById("Card").style.width = "auto";

         tweenSize(document.getElementById("Card"),
            BubbleXSize,
             BubbleYSize
            ,.1,1);


        tweenMove(document.getElementById("Card"),window.innerWidth/2,window.innerHeight/2,1,10);

        let LoadCase =  document.createElement('div');
        let LoadBox =  document.createElement('h1');
        LoadBox.textContent = "🧐";
        LoadCase.style.display = "flex";
        LoadCase.style.justifyContent = "center";
        LoadCase.style.alignItems = "center";

        LoadCase.classList.add("Case");
        LoadBox.classList.add("LoadBox");




        LoadCase.appendChild(LoadBox);
        document.getElementById("Page").appendChild(LoadCase);


        async function _blur(){
            for (let i = 0;i<10;i++){
                document.getElementById("BackGround").style.filter = "blur("+String(i+1)+"px)";
                await sleep(50);
            }
        }
        _blur();


        const Http = new XMLHttpRequest();
        const url= SqrData.Page;
        Http.open("GET", url);
        Http.send();


        Http.onload = async function() {
            await sleep(10);

            LoadCase.remove();

            if (inUi){

                let Data = JSON.parse(Http.responseText);
                for (let i = 0;i<Data.length;i++){

                    let CaseE = document.createElement('div');
                    if (i === 0) CaseE.style.paddingTop="60px";
                    CaseE.classList.add("Case");

                    let Title = Data[i]["Title"];
                    if (Title){
                        let TitleE = document.createElement('h1');
                        TitleE.textContent = Data[i]["Title"];
                        TitleE.classList.add("Title");
                        TitleE.style.color = "#" + hex(SqrData.Color,"444444", +1);
                        CaseE.appendChild(TitleE);
                    }




                    let Content = Data[i]["Content"];

                    if(Content){
                        let ContentE = document.createElement('h6');
                        ContentE.textContent = Data[i]["Content"];
                        ContentE.classList.add("Content");
                        ContentE.style.color = "#" + hex(SqrData.Color,"222222", +1);
                        CaseE.appendChild(ContentE);
                    }


                    let Images = Data[i]["Images"];

                    if (Images){
                        let ImagesCaseE = document.createElement('div');
                        ImagesCaseE.classList.add("ImagesCase");


                        for (let ImageIndex = 0 ;ImageIndex<Images.length; ImageIndex++){
                            let ImageE = document.createElement('img');
                            ImageE.classList.add("Image");
                            ImageE.src = Images[ImageIndex]["Image"];
                            ImageE.alt = Images[ImageIndex]["Text"];
                            ImageE.style.borderColor = "#" + hex(SqrData.Color,"222222", +1);




                            ImagesCaseE.appendChild(ImageE);

                        }
                        CaseE.appendChild(ImagesCaseE);
                    }

                    let Links = Data[i]["Links"];


                    if (Links){
                        let LinksCaseE = document.createElement('div');
                        LinksCaseE.classList.add("LinksCase");


                        for (let LinksIndex = 0 ;LinksIndex<Links.length; LinksIndex++){
                            let LinkE = document.createElement('a');
                            LinkE.classList.add("Link");
                            LinkE.href = Links[LinksIndex]["Link"];
                            LinkE.text = Links[LinksIndex]["Text"];
                            LinkE.style.color = "#" + hex(SqrData.Color,"444444", +1);




                            LinksCaseE.appendChild(LinkE);

                        }
                        CaseE.appendChild(LinksCaseE);
                    }

                    let Line = Data[i]["Line"];

                    if (Line){
                        let LineE = document.createElement('div');
                        LineE.classList.add("Line");
                        LineE.style.backgroundColor = "#" + hex(SqrData.Color,"222222", +1);
                        CaseE.appendChild(LineE);
                    }

                    let Videos = Data[i]["Videos"];

                    if (Videos){
                        let VideosCaseE = document.createElement('div');
                        VideosCaseE.classList.add("VideosCase");

                        for (let i = 0;i<Videos.length;i++){
                            let VideoE = document.createElement('video');
                            VideoE.classList.add("Video");
                            VideoE.src = Videos[i];

                            VideoE.controls = true;
                            VideoE.style.borderColor = "#" + hex(SqrData.Color,"222222", +1);


                            VideosCaseE.appendChild(VideoE);

                        }

                        CaseE.appendChild(VideosCaseE);


                    }



                    document.getElementById("Page").appendChild(CaseE);
                }
            }

            const scrollTop = document.getElementById("Page").scrollTop;
            const deg = (document.getElementById("Page").scrollHeight-document.getElementById("Page").clientHeight) !== 0 ?scrollTop/(document.getElementById("Page").scrollHeight-document.getElementById("Page").clientHeight) : 0.5;
            document.getElementById("Card").style.transform = "rotateX("+String((deg-0.5)*50)+"deg) translate(-50%, -50%)";
            console.log(deg);
        }



    }




}




let hasBeenMoved = false;
let isHolding = false;

let X0 = 0;
let Y0 = 0;

if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){

    window.alert("對不起，但我需要特別提醒你，本網站使用的程式碼對於低端設備用戶是很不友善的，還請見諒。");

    if(/iPad/i.test(navigator.userAgent)){
        BubbleXSize = 850;
        BubbleYSize = 650;
    }else{
        BubbleXSize = 800;
        BubbleYSize = 1000;
    }



    document.addEventListener('touchstart', (m) => {
        if (m.touches && m.touches.length === 1) {
             X0 = m.touches[0].clientX;
             Y0 = m.touches[0].clientY;

            if (inUi || m.button) return;

            isHolding = true;
            hasBeenMoved = false;
        }
    });

    document.addEventListener('touchmove', (m) => {
        if (m.touches && m.touches.length === 1) {
            const touch = m.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            if (isHolding){
                if (inUi){
                    X0 = x;
                    Y0 = y;

                    return;
                }

                if (X0&&Y0){}else{
                    X0 = x;
                    Y0 = y;
                }


                if (Math.abs(x - X0  ) > 75){
                    let db =  X0-x > 0;
                    let IF = db?(MidX+1<mapSize ? (typeof  Bubbles[MidY][MidX+1]) === "number":false): (MidX-1>=0 ? (typeof  Bubbles[MidY][MidX-1]) === "number" : false);

                    hasBeenMoved = true;


                    if (IF){

                        if (db){
                            MidX=MidX+1;
                        }else{
                            MidX=MidX-1;

                        }

                        a();

                    }
                    X0 = x;


                }

                if (Math.abs(y -Y0) > 75){
                    let db =  Y0-y > 0;
                    let IF = db?(MidY+1<mapSize ? (typeof  Bubbles[MidY+1][MidX]) === "number":false): (MidY-1>=0 ? (typeof  Bubbles[MidY-1][MidX]) === "number" : false);


                    hasBeenMoved = true;


                    if (IF){
                        if (db){
                            MidY=MidY+1;
                        }else{
                            MidY=MidY-1;

                        }

                        a();


                    }
                    Y0 = y;
                }
            }
        }
    });

    document.addEventListener('touchend', (m) => {
        isHolding = false;
        if ((!hasBeenMoved || inUi )&& !m.button)  {

            if (m.target.classList[0] !== "MessageTouchBox")
            {
                let sa = function(zzz){

                    if (zzz) {
                        if(zzz.id === "body")return false;
                    }else{
                        return false;
                    }

                    if (zzz.id === "Card" ){

                        return true;
                    }else{

                        return sa( zzz.parentElement);
                    }
                }
                if (sa( m.target)){

                }else{

                    ent();
                }
            }

        }

    });
}else{
    document.addEventListener('mousedown', (m) => {
        if (inUi || m.button) return;

        isHolding = true;
        hasBeenMoved = false;

        X0 = m.clientX;
        Y0 = m.clientY;
    });


    document.addEventListener("keydown", function(event) {
        if (inUi) return;
        if (event.key === "ArrowUp") {

            if ( MidY-1 >= 0 && (typeof Bubbles[MidY-1][MidX]) === "number" ){
                MidY += -1;
            }else{

                return;
            }


            a();
        }
        if (event.key === "ArrowDown") {
            if ( MidY+1<=mapSize-1 &&  typeof Bubbles[MidY+1][MidX]  === "number" ){
                MidY += 1;
            }else{
                return;
            }

            a();
        }

        if (event.key === "ArrowLeft") {
            if (  MidX-1 >= 0 && typeof  Bubbles[MidY][MidX-1] === "number"){
                MidX += -1;
            }else{
                return;
            }

            a();
        }
        if (event.key === "ArrowRight") {
            if ( MidX+1<=mapSize-1  && typeof  Bubbles[MidY][MidX+1] === "number"){
                MidX += 1;
            }else{
                return;
            }

            a();
        }


    });

    let atSquare = -1;

    let lMSL = 0;
    document.addEventListener("keydown",  function(event) {
        if (event.key === "Enter" && !inUi) ent();
        if (event.key === "Escape" && inUi) ent();
        if (event.code === "Space" && !inUi) {

            let i=0;

            for(let y = 0; y < mapSize; y++){
                for (let x = 0; x < mapSize; x++){
                    if(i === atSquare) {
                        MidX = x;
                        MidY = y;

                        atSquare = -1;

                        a();
                        break;
                    }
                    i++;
                }
            }
        }
        if (event.code === "KeyC" && event.ctrlKey && !inUi) {
            MessageIt("泡泡超連結！","已複製 「"+ BubbleInfos[atSquare].Name +"」的超連結。")
            navigator.clipboard.writeText("https://hxx.lol/?bubble="+BubbleInfos[atSquare].id);
            atSquare = -1;
        }

        if(event.code === "KeyL" && !lMSL){
            lMSL++;
            MessageIt("林...林....林亮教！","你觸發了不該觸發的東西...");
            creatBubble(LimSquares["msl"]);
            a();
        }
    });

    document.addEventListener('mouseup', (m) => {

        isHolding = false;
        if ((!hasBeenMoved || inUi )&& !m.button)  {

            if (m.target.classList[0] !== "MessageTouchBox")
            {
                let sa = function(zzz){

                    if (zzz) {
                        if(zzz.id === "body")return false;
                    }else{
                        return false;
                    }

                    if (zzz.id === "Card" ){

                        return true;
                    }else{

                        return sa( zzz.parentElement);
                    }
                }
                if (sa( m.target)){

                }else{

                    ent();
                }
            }

        }

    });





    let getDad = function (c,b){
        if (c.classList[0] === b){
            return c;
        }else{
            if(c.id === "body") return false;
            return getDad(c.parentElement,b);
        }
    }

    document.addEventListener('mousemove', (m) => {

        if (isHolding){
            if (inUi){
                X0 = m.clientX;
                Y0 = m.clientY;

                return;
            }

            if (X0&&Y0){}else{
                X0 = m.clientX;
                Y0 = m.clientY;
            }


            if (Math.abs(m.clientX - X0  ) > 75){
                let db =  X0-m.clientX > 0;
                let IF = db?(MidX+1<mapSize ? (typeof  Bubbles[MidY][MidX+1]) === "number":false): (MidX-1>=0 ? (typeof  Bubbles[MidY][MidX-1]) === "number" : false);

                hasBeenMoved = true;


                if (IF){

                    if (db){
                        MidX=MidX+1;
                    }else{
                        MidX=MidX-1;

                    }

                    a();

                }
                X0 = m.clientX;


            }

            if (Math.abs(m.clientY -Y0) > 75){
                let db =  Y0-m.clientY > 0;
                let IF = db?(MidY+1<mapSize ? (typeof  Bubbles[MidY+1][MidX]) === "number":false): (MidY-1>=0 ? (typeof  Bubbles[MidY-1][MidX]) === "number" : false);


                hasBeenMoved = true;


                if (IF){
                    if (db){
                        MidY=MidY+1;
                    }else{
                        MidY=MidY-1;

                    }

                    a();


                }
                Y0 = m.clientY;

            }
        }else{

            let doc = document.getElementById("doc")
            let states = getDad(m.target,"aState");
            let Squ = getDad(m.target,"Square");

            if(states){
                doc.style.top = m.clientY + "px";
                doc.style.left = m.clientX + "px";
                doc.style.opacity = "1";

                doc.classList.add("IsState");

                let title = "不明";

                for(let l = 0;l<BubbleInfos[Squ.classList[1]].states.length; l++){
                    if(BubbleInfos[Squ.classList[1]].states[l][0] === states.innerText){
                        title = BubbleInfos[Squ.classList[1]].states[l][1];
                        break;
                    }
                }

                doc.innerText = title;

                atSquare = Number(Squ.classList[1]);

            }else{

                doc.classList.remove("IsState");


                if (Squ){
                    doc.style.top = m.clientY + "px";
                    doc.style.left = m.clientX + "px";
                    doc.style.opacity = "1";


                    doc.innerText = BubbleInfos[Squ.classList[1]].Name;

                    atSquare = Number(Squ.classList[1]);

                }else{
                    atSquare = -1;
                    doc.style.opacity = "0";

                    if (m.target.classList[0] === "MessageTouchBox"){
                        let SizeBoxX_P2 =m.target.getBoundingClientRect().width/2;
                        let SizeBoxY_P2 =m.target.getBoundingClientRect().height/2;

                        let PosBoxX =m.target.getBoundingClientRect().left;
                        let PosBoxY =m.target.getBoundingClientRect().top;

                        let MouseX = m.clientX;
                        let MouseY = m.clientY;

                        let _X = ( MouseX -PosBoxX )-SizeBoxX_P2;
                        let _Y = (MouseY - PosBoxY )-SizeBoxY_P2;

                        msgStyle3d ="rotate3d("+(_X/SizeBoxX_P2*7)+" ,"+(_Y/SizeBoxY_P2*7)+ ","+((_X/SizeBoxX_P2)*(_Y/SizeBoxY_P2))+",18deg) translate(-50%,-50%)";

                        for (let i = 0;i<   document.getElementById("MessagesCase").children.length;i++){
                            document.getElementById("MessagesCase").children[i].style.transform = msgStyle3d;
                        }
                    }
                }
            }
        }
    })
}








window.addEventListener('resize', function() {
    a();
    ent(true);
});
